@using Nager.Date
@using Spire.Pdf.Exporting.XPS.Schema
@model MovieHub.ViewModels.OrderViewModel

@{
    var title = Model!.Movie!.Title;
    ViewData["Title"] = "Buy '" + title + "' tickets";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<script>

let ticketQuantity;
let ticketTypeId;
let packageQuantity;
let CateringPackageId;

function SaveToLocalStorage() {
 
    let movieId = @Model.Movie.Id;
    let ticketTypes = CountTickets(ticketQuantity, ticketTypeId);
    let cateringPackages = CountTickets(packageQuantity, CateringPackageId);
    
    // Showinfo:
    let selectedShow = document.getElementById('selectedShow')
    let showtimeId = parseInt(selectedShow.value)
    
    localStorage.setItem('orderData', JSON.stringify({movieId, showtimeId, ticketTypes, cateringPackages})); 
    
}

function BuyTickets()
{
    // Showinfo:
    let selectedShow = document.getElementById('selectedShow')
    let showtimeId = parseInt(selectedShow.value)
   
    // Ticketinfo: 
    ticketQuantity = document.querySelectorAll('.ticketQuantity')
    ticketTypeId = document.querySelectorAll('.ticketTypeId')
    let totalTickets = TotalTickets(ticketQuantity)
    
    //Packageinfo:
    packageQuantity = document.querySelectorAll('.packageQuantity')
    CateringPackageId = document.querySelectorAll('.cateringPackageId')
    
    // 
    if (!showtimeId || totalTickets === 0) {
        document.getElementById('ErrorNoSelection').style.color = "red";
        document.getElementById('ErrorNoSelection').innerHTML = "Please fill in all fields";
        return
    }
    SaveToLocalStorage();    
    location.href='@Url.Action("Index", "Seats")?showtimeId='+JSON.stringify(showtimeId);
    
    
}

function CountTickets (quantity, id) {
    let ticketTypes = {};
  
    for (let i = 0; i < quantity.length; i++)
    {
        ticketTypes[id[i].innerHTML] = parseInt(quantity[i].value);
    }
    return ticketTypes;
}

function TotalTickets(ticketQuantity) {
    let sumTq = 0;
    
    ticketQuantity.forEach((tq, index) => {
        
        sumTq = sumTq + parseInt(tq.value)
    })
    return sumTq
}
</script>

<div class="container" style="margin-top: 120px">
    <dl class="row">
        <div class="col-4">
            <img src="@Url.Content(@Model.Movie.ImageUrl)" alt="test" width="80%"/>
        </div>
        <div class="col-8">
            <h3>@Html.DisplayFor(model => model.Movie!.Title)</h3>

            <div class="form-group" style="width: 30%">
                @Html.LabelFor(m => Model.Showtime, new { @class = "control-label col-md-2" })
                <div>
                    @Html.DropDownListFor(m => Model.Showtime!.StartAt, new SelectList(Model.ShowList, "Value", "Text"), "Select show", new { @class = "form-control", id="selectedShow"})
                </div>
            </div>
            
            <br/>
            <h4>Ticket Selection:</h4>
        
            <table>
                <tr>
                    <th>Quantity</th>
                    <th>Name</th>
                    <th>Price</th>
                    <th>Details</th>
                </tr>

                @foreach (var ticket in Model.Tickettypes)
                {
                    var dateNow = DateTime.Now;
                    var day = DateTime.Now.DayOfWeek;
                    var kidsBedTime = new DateTime(dateNow.Year, dateNow.Month, dateNow.Day, 18, 0, 0);

                    // TODO:    working on logic for kids discount add pegi rating
                    //          Problem is.... there are pegi ratings in db yet
                    if (((ticket.Name == "Kids") &
                         (

                        @* COMMENTED OUT BECAUSE SHOWTIME LATER ADDED TODO*@
                             // (Model.Showtime.StartAt > kidsBedTime) |
        
                             (Model.Movie.Language != "Dutch")
                             )
                         | ((ticket.Name == "Students") & (!(day >= DayOfWeek.Monday & day <= DayOfWeek.Thursday)) |
                            ((((ticket.Name == "65+") & ((!(day >= DayOfWeek.Monday & day <= DayOfWeek.Thursday)) |
                                                         ((DateSystem.IsPublicHoliday(dateNow, CountryCode.NL))))))))))
                    {
                        Console.WriteLine(ticket.Name + "Should be excluded");
                        continue;
                    }

                    if (ticket.Name != "3D")
                    {
                        <tr>
                            <td hidden="hidden" class="ticketTypeId">@ticket.Id</td>
                            <td style="width: 30%"><input type="number" asp-for=@ticket.Quantity class="form-control ticketQuantity" placeholder="Number of Tickets" min="1" max="10"/></td>
                            <td>@ticket.Name</td>
                            <td>@ticket.Price</td>
                            <td>@ticket.Description</td>
                        </tr>
                    }
                }
            </table>
        
            <br/><br/>
            <h4>Catering Arrangements:</h4>
            <table>
                <tr>
                    <th>Quantity</th>
                    <th>Product</th>
                    <th>Price</th>
                </tr>
        
        
                @{
                    System.Diagnostics.Debug.Assert(Model.CateringPackages != null, "Model.CateringPackages != null");
                }
                @foreach (var package in Model.CateringPackages)
                {
        
                    <tr>
                        <td hidden="hidden" class="cateringPackageId">@package.Id</td>
                        <td style="width: 30%"><input type="number" asp-for=@package.Quantity class="form-control packageQuantity" placeholder="Number of Tickets" min="1" max="10"/></td>
                        <td>@package.Description</td>
                        <td>@package.Price</td>
                    </tr>
        
                }
            </table>
            <br/><br/>
            <button onclick="BuyTickets()" class="btn btn-primary btn-sizing ms-1" style="margin-bottom: 2px">Select seats</button>
            <p class="text-center" id="ErrorNoSelection"></p>
        </div>
        
    </dl>
    <br/>
</div>
